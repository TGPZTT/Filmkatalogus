<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Film Katalógus</title>
    <!-- Tailwind CSS betöltése -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter betűtípus -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Rejtett fájl bemenet */
        #load-input {
            display: none;
        }
        /* Egyedi scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #374151; /* gray-700 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #4b5563; /* gray-600 */
        }
        /* Csillag értékelő hover effektus */
        .rating-stars:hover .rating-star svg {
            color: #9ca3af; /* gray-400 */
        }
        .rating-star:hover ~ .rating-star svg {
            color: #4b5563; /* gray-600 */
        }
        .rating-stars .rating-star:hover svg {
             color: #f59e0b; /* yellow-500 */
        }
        /* Címke (tag) stílusok */
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 12px;
            min-height: 28px; /* Hogy ne ugráljon a layout, ha nincs tag */
        }
        .tag-badge {
            display: inline-flex;
            align-items: center;
            background-color: #374151; /* gray-700 */
            color: #d1d5db; /* gray-300 */
            font-size: 0.8rem;
            font-weight: 500;
            border-radius: 9999px;
            padding: 3px 6px 3px 10px;
        }
        .remove-tag-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #4b5563; /* gray-600 */
            color: #d1d5db; /* gray-300 */
            margin-left: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }
        .remove-tag-btn:hover {
            background-color: #ef4444; /* red-500 */
            color: white;
            transform: scale(1.1);
        }
        .add-tag-form {
            display: flex;
            margin-top: 10px;
            gap: 5px;
        }
        .tag-input {
            flex-grow: 1;
            background-color: #4b5563; /* gray-600 */
            border: 1px solid #52525b; /* gray-500 */
            color: white;
            border-radius: 6px;
            padding: 5px 8px;
            font-size: 0.9rem;
            min-width: 0;
        }
        .add-tag-btn {
            background-color: #1d4ed8; /* blue-700 */
            color: white;
            border: none;
            border-radius: 6px;
            padding: 0 12px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .add-tag-btn:hover {
            background-color: #1e40af; /* blue-800 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 antialiased min-h-screen">

    <div class="container mx-auto max-w-7xl p-4 sm:p-8">
        
        <!-- Címsor -->
        <header class="text-center mb-10">
            <h1 class="text-4xl sm:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                Film Katalógus
            </h1>
        </header>

        <main>
            <!-- Vezérlőpult: Keresés, Mentés, Betöltés -->
            <section id="controls" class="mb-8 p-6 bg-gray-800 rounded-2xl shadow-xl">
                <div class="flex flex-col sm:flex-row flex-wrap gap-4 justify-between items-center">
                    <!-- Keresőmező (Helyi katalógusban) -->
                    <div class="w-full sm:w-auto sm:flex-1 sm:min-w-[300px]">
                        <label for="search-box" class="block text-sm font-medium text-gray-300 mb-2">Keresés a saját katalógusban</label>
                        <input 
                            type="search" 
                            id="search-box"
                            placeholder="Keresés a filmcímek között..."
                            class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all duration-200"
                        />
                    </div>
                    <!-- Gombok -->
                    <div class="flex gap-3 mt-4 sm:mt-0 self-end">
                        <button id="save-btn" class="bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-5 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                            Mentés (.csv)
                        </button>
                        <button id="load-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-5 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200">
                            Betöltés (.csv)
                        </button>
                        <input type="file" id="load-input" accept=".csv">
                    </div>
                </div>
            </section>

            <!-- Film keresése (OMDB) űrlap -->
            <section id="add-movie-section" class="mb-10 p-6 bg-gray-800 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold mb-6 text-center sm:text-left">Új Film Keresése Cím Alapján</h2>
                <form id="search-omdb-form" class="grid grid-cols-1 md:grid-cols-4 gap-5 items-end">
                    <div class="md:col-span-3">
                        <label for="search-term-input" class="block text-sm font-medium text-gray-300 mb-2">Film Címe</label>
                        <input type="text" id="search-term-input" required placeholder="Pl: The Matrix, Inception, stb." class="w-full bg-gray-700 border border-gray-600 rounded-lg px-4 py-3 text-white focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div class="md:col-span-1 text-center">
                        <button type="submit" id="search-omdb-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-10 rounded-lg shadow-md transform hover:scale-105 transition-all duration-200 flex items-center justify-center min-h-[50px]">
                            <span id="search-btn-text">Keresés</span>
                            <svg id="search-btn-spinner" class="animate-spin h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </form>
            </section>

            <!-- Film Katalógus Rács -->
            <section id="movie-catalog">
                <h2 class="text-3xl font-bold mb-6 border-b border-gray-700 pb-3">Saját Katalógus</h2>
                <div id="catalog-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6">
                    <!-- A film kártyák ide kerülnek beillesztésre JS-sel -->
                </div>
                <p id="no-results" class="text-center text-gray-400 text-xl mt-10 hidden">Nincs a keresésnek megfelelő találat.</p>
                <p id="empty-catalog" class="text-center text-gray-400 text-xl mt-10 hidden">A katalógus még üres. Keress filmeket a fenti űrlappal!</p>
            </section>

        </main>

        <!-- Egyedi üzenet ablak (alert helyett) -->
        <div id="message-box" class="fixed bottom-5 right-5 bg-red-600 text-white py-3 px-5 rounded-lg shadow-lg opacity-0 transition-all duration-300 translate-y-10 z-50">
            <span id="message-text"></span>
        </div>

        <!-- Keresési Eredmények Modál -->
        <div id="search-modal" class="fixed inset-0 bg-black bg-opacity-75 z-40 hidden flex items-center justify-center p-4">
            <div class="bg-gray-800 w-full max-w-5xl max-h-[85vh] rounded-2xl shadow-xl flex flex-col">
                <header class="p-5 flex justify-between items-center border-b border-gray-700">
                    <h2 class="text-2xl font-bold">Keresési Eredmények</h2>
                    <button id="close-modal-btn" class="text-gray-400 hover:text-white transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </header>
                <div id="search-results-wrapper" class="p-6 overflow-y-auto">
                    <div id="search-results-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-5">
                        <!-- Keresési eredmények kártyái ide jönnek -->
                    </div>
                </div>
                <div id="search-loading" class="p-10 text-center hidden">
                    <svg class="animate-spin h-10 w-10 text-blue-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <div id="search-no-results" class="p-10 text-center text-gray-400 text-xl hidden">
                    Nincs találat erre a kifejezésre.
                </div>
            </div>
        </div>

    </div>

    <!-- Globális Datalist az autokiegészítéshez -->
    <datalist id="all-tags-list">
        <!-- JS tölti fel -->
    </datalist>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // === DOM Elemek ===
            const searchOmdbForm = document.getElementById('search-omdb-form');
            const searchTermInput = document.getElementById('search-term-input');
            const searchOmdbBtn = document.getElementById('search-omdb-btn');
            const searchBtnText = document.getElementById('search-btn-text');
            const searchBtnSpinner = document.getElementById('search-btn-spinner');
            
            const catalogGrid = document.getElementById('catalog-grid');
            const searchBox = document.getElementById('search-box'); // Helyi kereső
            
            const saveBtn = document.getElementById('save-btn');
            const loadBtn = document.getElementById('load-btn');
            const loadInput = document.getElementById('load-input');
            
            const noResultsMsg = document.getElementById('no-results');
            const emptyCatalogMsg = document.getElementById('empty-catalog');
            
            const messageBox = document.getElementById('message-box');
            const messageText = document.getElementById('message-text');

            // Modál elemek
            const searchModal = document.getElementById('search-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const searchResultsWrapper = document.getElementById('search-results-wrapper');
            const searchResultsGrid = document.getElementById('search-results-grid');
            const searchLoading = document.getElementById('search-loading');
            const searchNoResults = document.getElementById('search-no-results');

            // === Alkalmazás állapota (State) ===
            let movies = [];
            let allTags = []; // ÚJ: Globális címke lista
            const OMDB_API_KEY = '7f4955d5'; // Felhasználó által biztosított kulcs

            // === FUNKCIÓK ===

            /**
             * Egyedi üzenet megjelenítése (alert helyett)
             */
            function showMessage(message, type = 'error') {
                messageText.textContent = message;
                messageBox.classList.remove('bg-red-600', 'bg-green-600');
                
                if (type === 'success') {
                    messageBox.classList.add('bg-green-600');
                } else {
                    messageBox.classList.add('bg-red-600');
                }

                messageBox.classList.remove('opacity-0', 'translate-y-10');
                
                setTimeout(() => {
                    messageBox.classList.add('opacity-0', 'translate-y-10');
                }, 3000); // 3 másodperc múlva eltűnik
            }

            /**
             * A filmek tömb alapján újrarendereli a *saját* katalógus nézetet.
             * @param {Array} movieList - A megjelenítendő filmek listája (alapértelmezetten a teljes lista).
             */
            function renderMovies(movieList = movies) {
                catalogGrid.innerHTML = ''; // Rács kiürítése
                noResultsMsg.classList.add('hidden');
                emptyCatalogMsg.classList.add('hidden');

                if (movies.length === 0) {
                    emptyCatalogMsg.classList.remove('hidden');
                    return;
                }

                if (movieList.length === 0 && movies.length > 0) {
                    noResultsMsg.classList.remove('hidden');
                    return;
                }

                movieList.forEach(movie => {
                    // Csillagok generálása az értékelés alapján
                    let starsHTML = '';
                    for (let i = 1; i <= 5; i++) {
                        const starClass = movie.userRating >= i ? 'text-yellow-400' : 'text-gray-600';
                        starsHTML += `
                            <svg data-value="${i}" class="rating-star w-6 h-6 cursor-pointer ${starClass} hover:text-yellow-300" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                                <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path>
                            </svg>
                        `;
                    }

                    // ÚJ: Címkék generálása
                    let tagsHTML = '';
                    if (movie.tags) {
                        movie.tags.forEach(tag => {
                            tagsHTML += `
                                <span class="tag-badge">
                                    ${tag}
                                    <button 
                                        class="remove-tag-btn" 
                                        data-movie-id="${movie.id}" 
                                        data-tag-name="${tag}"
                                        title="Címke törlése"
                                    >
                                        &times;
                                    </button>
                                </span>
                            `;
                        });
                    }

                    const movieCard = `
                        <div class="bg-gray-800 rounded-lg shadow-lg overflow-hidden transform hover:scale-[1.03] transition-transform duration-300 group relative flex flex-col">
                            <!-- Törlés gomb -->
                            <button 
                                data-id="${movie.id}" 
                                class="delete-btn absolute top-3 right-3 bg-red-600 text-white rounded-full p-0 w-8 h-8 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all duration-200 z-10 hover:bg-red-700 transform hover:scale-110"
                                title="Film törlése"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                            
                            <!-- Kép -->
                            <img 
                                src="${movie.poster}" 
                                alt="${movie.title} poszter" 
                                class="w-full h-80 object-cover group-hover:opacity-75 transition-opacity duration-300"
                                onerror="this.onerror=null; this.src='https://placehold.co/400x600/374151/9ca3af?text=Kép\\nHiba'; this.classList.add('object-contain');"
                            >
                            
                            <!-- Tartalom -->
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-xl font-bold mb-2 truncate flex-grow" title="${movie.title}">${movie.title}</h3>
                                
                                <!-- Értékelés -->
                                <div class="rating-stars flex items-center my-3" data-id="${movie.id}">
                                    ${starsHTML}
                                </div>

                                <!-- ÚJ: Címke szekció -->
                                <div class="tag-container mb-4">
                                    ${tagsHTML}
                                </div>
                                <form class="add-tag-form mb-4" data-id="${movie.id}">
                                    <input type="text" list="all-tags-list" class="tag-input" placeholder="Címke hozzáadása...">
                                    <button type="submit" class="add-tag-btn" title="Hozzáadás">+</button>
                                </form>

                                ${movie.imdb ? `
                                <a 
                                    href="${movie.imdb}" 
                                    target="_blank" 
                                    rel="noopener noreferrer" 
                                    class="inline-block bg-yellow-500 text-gray-900 text-sm font-semibold px-3 py-1 rounded-full hover:bg-yellow-400 transition-colors duration-200 self-start"
                                >
                                    Megtekintés IMDB-n
                                </a>
                                ` : ''}
                            </div>
                        </div>
                    `;
                    catalogGrid.innerHTML += movieCard;
                });
            }

            /**
             * Menti a jelenlegi film listát a localStorage-be.
             */
            function saveToLocalStorage() {
                localStorage.setItem('movieCatalog', JSON.stringify(movies));
                localStorage.setItem('movieTags', JSON.stringify(allTags)); // ÚJ: Címkék mentése
            }

            /**
             * Betölti a filmeket a localStorage-ből.
             */
            function loadFromLocalStorage() {
                const savedMovies = localStorage.getItem('movieCatalog');
                if (savedMovies) {
                    movies = JSON.parse(savedMovies);
                    // Biztosítjuk, hogy a régi mentések is kapjanak userRating és tags mezőt
                    movies.forEach(m => {
                        if (m.userRating === undefined) {
                            m.userRating = 0;
                        }
                        if (m.tags === undefined) { // ÚJ
                            m.tags = [];
                        }
                    });
                }

                // ÚJ: Címkék betöltése
                const savedTags = localStorage.getItem('movieTags');
                if (savedTags) {
                    allTags = JSON.parse(savedTags);
                }
            }

            /**
             * ÚJ: Frissíti a globális <datalist>-et az autokiegészítéshez
             */
            function updateAllTagsDatalist() {
                const datalist = document.getElementById('all-tags-list');
                if (datalist) {
                    datalist.innerHTML = '';
                    allTags.forEach(tag => {
                        datalist.innerHTML += `<option value="${tag}">`;
                    });
                }
            }

            /**
             * Keresés gomb és spinner állapotának kezelése
             */
            function setSearchButtonLoading(isLoading) {
                if (isLoading) {
                    searchOmdbBtn.disabled = true;
                    searchBtnText.classList.add('hidden');
                    searchBtnSpinner.classList.remove('hidden');
                } else {
                    searchOmdbBtn.disabled = false;
                    searchBtnText.classList.remove('hidden');
                    searchBtnSpinner.classList.add('hidden');
                }
            }

            /**
             * Film keresése az OMDB-n cím alapján.
             */
            async function handleOMDBSearch(e) {
                e.preventDefault();
                const searchTerm = searchTermInput.value.trim();
                if (!searchTerm) {
                    showMessage('Kérlek, adj meg egy filmcímet a kereséshez!');
                    return;
                }

                setSearchButtonLoading(true);
                searchModal.classList.remove('hidden');
                searchModal.classList.add('flex');
                searchLoading.classList.remove('hidden');
                searchNoResults.classList.add('hidden');
                searchResultsGrid.innerHTML = '';
                searchResultsWrapper.scrollTop = 0; // Görgetés tetejére

                // Regex az IMDB ID formátum ellenőrzésére (pl. tt1234567)
                const imdbIdPattern = /^tt\d{7,9}$/i;
                let apiUrl = '';

                if (imdbIdPattern.test(searchTerm)) {
                    // Keresés IMDB ID alapján (egy film)
                    apiUrl = `https://www.omdbapi.com/?i=${searchTerm}&apikey=${OMDB_API_KEY}`;
                } else {
                    // Keresés cím alapján (lista) - KIVETTÜK A &type=movie MEGKÖTÉST
                    apiUrl = `https://www.omdbapi.com/?s=${searchTerm}&apikey=${OMDB_API_KEY}`;
                }

                try {
                    const response = await fetch(apiUrl);
                    const data = await response.json();

                    if (data.Response === "True") {
                        if (imdbIdPattern.test(searchTerm)) {
                            // ID keresés egyetlen objektumot ad vissza.
                            // A renderSearchResults tömböt vár, ezért tömbbe csomagoljuk.
                            renderSearchResults([data]);
                        } else {
                            // Cím keresés listát ad (data.Search)
                            renderSearchResults(data.Search);
                        }
                        searchNoResults.classList.add('hidden');
                    } else {
                        searchNoResults.classList.remove('hidden');
                    }
                } catch (error) {
                    console.error("OMDB Keresési Hiba:", error);
                    showMessage('Hiba történt a keresés közben. Ellenőrizd az internetkapcsolatot.');
                    searchNoResults.classList.remove('hidden');
                } finally {
                    setSearchButtonLoading(false);
                    searchLoading.classList.add('hidden');
                }
            }
            
            /**
             * Keresési eredmények megjelenítése a modálban.
             */
            function renderSearchResults(results) {
                searchResultsGrid.innerHTML = '';
                results.forEach(result => {
                    // Ellenőrizzük, hogy ez a film már a listánkon van-e
                    const alreadyAdded = movies.some(m => m.imdb && m.imdb.includes(result.imdbID));
                    
                    const card = `
                        <div class="bg-gray-700 rounded-lg shadow-lg overflow-hidden flex flex-col">
                            <img 
                                src="${result.Poster}" 
                                alt="${result.Title} poszter" 
                                class="w-full h-64 object-cover"
                                onerror="this.onerror=null; this.src='https://placehold.co/300x450/374151/9ca3af?text=Nincs\\nPoszter'; this.classList.add('object-contain');"
                            >
                            <div class="p-4 flex flex-col flex-grow">
                                <h3 class="text-lg font-bold mb-1 truncate flex-grow" title="${result.Title}">${result.Title}</h3>
                                <p class="text-sm text-gray-400 mb-4">${result.Year}</p>
                                <button 
                                    class="add-from-search-btn w-full mt-auto px-4 py-2 rounded-lg font-semibold transition-all duration-200 ${alreadyAdded ? 'bg-green-600 text-white cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700 text-white'}"
                                    data-imdbid="${result.imdbID}"
                                    ${alreadyAdded ? 'disabled' : ''}
                                >
                                    ${alreadyAdded ? 'Hozzáadva' : 'Hozzáadás a listához'}
                                </button>
                            </div>
                        </div>
                    `;
                    searchResultsGrid.innerHTML += card;
                });
            }

            /**
             * Film hozzáadása a keresési eredményből (modálból).
             */
            async function handleAddFromSearch(e) {
                const btn = e.target.closest('.add-from-search-btn');
                if (!btn) return;

                btn.disabled = true;
                btn.textContent = 'Hozzáadás...';
                const imdbID = btn.dataset.imdbid;

                // Ellenőrzés (bár a gomb már disabled, dupla kattintás ellen jó)
                if (movies.some(m => m.imdb && m.imdb.includes(imdbID))) {
                    btn.textContent = 'Hozzáadva';
                    return;
                }

                try {
                    // Teljes filmadatok lekérése ID alapján
                    const response = await fetch(`https://www.omdbapi.com/?i=${imdbID}&apikey=${OMDB_API_KEY}`);
                    const data = await response.json();

                    if (data.Response === "False") {
                        showMessage(`Hiba: ${data.Error || 'Ismeretlen hiba az API-tól.'}`);
                        btn.disabled = false;
                        btn.textContent = 'Hozzáadás a listához';
                        return;
                    }

                    const newMovie = {
                        id: crypto.randomUUID(), // Egyedi azonosító
                        title: data.Title,
                        imdb: `https://www.imdb.com/title/${data.imdbID}/`,
                        poster: data.Poster,
                        userRating: 0, // Alapértelmezett értékelés
                        tags: [] // ÚJ: Üres címke lista
                    };

                    movies.unshift(newMovie); // Hozzáadás a tömb elejére
                    saveToLocalStorage();
                    renderMovies(getFilteredMovies()); // Fő rács frissítése
                    showMessage('Film sikeresen hozzáadva!', 'success');
                    btn.textContent = 'Hozzáadva';

                } catch (error) {
                    console.error("OMDB Hozzáadási Hiba:", error);
                    showMessage('Hiba történt a film hozzáadása közben.');
                    btn.disabled = false;
                    btn.textContent = 'Hozzáadás a listához';
                }
            }
            
            /**
             * ÚJ: Címke hozzáadása egy filmhez
             */
            function handleAddTag(movieId, tagName) {
                const movie = movies.find(m => m.id === movieId);
                if (movie && !movie.tags.includes(tagName)) {
                    movie.tags.push(tagName);
                    movie.tags.sort(); // ABC sorrendbe rendezés

                    // Hozzáadás a globális listához, ha még nincs benne
                    if (!allTags.includes(tagName)) {
                        allTags.push(tagName);
                        allTags.sort();
                        updateAllTagsDatalist(); // Autokiegészítő frissítése
                    }
                    
                    saveToLocalStorage();
                    renderMovies(getFilteredMovies()); // Teljes újrarajzolás
                }
            }

            /**
             * ÚJ: Címke eltávolítása egy filmről
             */
            function handleRemoveTag(movieId, tagName) {
                const movie = movies.find(m => m.id === movieId);
                if (movie) {
                    movie.tags = movie.tags.filter(t => t !== tagName);
                    saveToLocalStorage();
                    renderMovies(getFilteredMovies()); // Teljes újrarajzolás
                    // Megjegyzés: a globális 'allTags' listából szándékosan nem töröljük.
                }
            }


            /**
             * Modál bezárása.
             */
            function closeModal() {
                searchModal.classList.add('hidden');
                searchModal.classList.remove('flex');
            }

            /**
             * Film törlése ID alapján.
             */
            function deleteMovie(id) {
                movies = movies.filter(movie => movie.id !== id);
                saveToLocalStorage();
                renderMovies(getFilteredMovies()); // Újrarenderelés a szűrt lista alapján
                showMessage('Film törölve.', 'success');
                // Frissítjük a modál gombjait, ha nyitva van
                updateModalButtons();
            }
            /**
 * ÚJ: Felhasználói értékelés kezelése (csillagozás)
 * @param {string} movieId - A film azonosítója
 * @param {number} ratingValue - Az új értékelés (1–5)
 */
function handleRatingClick(movieId, ratingValue) {
    const movie = movies.find(m => m.id === movieId);
    if (!movie) return;

    // Értékelés mentése
    movie.userRating = ratingValue;

    // Állapot mentése és újrarenderelés
    saveToLocalStorage();
    renderMovies(getFilteredMovies());

    // Visszajelzés
    showMessage(`Értékelés mentve: ${ratingValue} ⭐`, 'success');
}

            /**
             * Frissíti a modálban lévő gombok állapotát (pl. törlés után)
             */
            function updateModalButtons() {
                const buttons = searchResultsGrid.querySelectorAll('.add-from-search-btn');
                buttons.forEach(btn => {
                    const imdbID = btn.dataset.imdbid;
                    const alreadyAdded = movies.some(m => m.imdb && m.imdb.includes(imdbID));
                    if (alreadyAdded) {
                        btn.disabled = true;
                        btn.textContent = 'Hozzáadva';
                        btn.classList.add('bg-green-600', 'cursor-not-allowed');
                        btn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                    } else {
                        btn.disabled = false;
                        btn.textContent = 'Hozzáadás a listához';
                        btn.classList.remove('bg-green-600', 'cursor-not-allowed');
                        btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                    }
                });
            }

            /**
             * Visszaadja a *helyi* keresőmező alapján szűrt filmek listáját.
             */
            function getFilteredMovies() {
                const searchTerm = searchBox.value.toLowerCase();
                return movies.filter(movie => 
                    movie.title.toLowerCase().includes(searchTerm)
                );
            }

            /**
             * Helyi keresőmező eseménykezelője.
             */
            function handleLocalSearch() {
                renderMovies(getFilteredMovies());
            }

            /**
             * Egy stringet CSV-biztossá tesz.
             */
            function escapeCSV(str) {
                if (str === null || str === undefined) {
                    str = "";
                }
                str = String(str);
                if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                    return `"${str.replace(/"/g, '""')}"`;
                }
                return str;
            }

            /**
             * Katalógus mentése .csv fájlba (értékeléssel együtt).
             */
            function saveCatalogToFile() {
                if (movies.length === 0) {
                    showMessage('Nincs mit menteni, a katalógus üres!');
                    return;
                }
                
                const header = "id,title,imdb,poster,userRating,tags\n"; // Új mező: tags
                const rows = movies.map(m => {
                    return [
                        escapeCSV(m.id),
                        escapeCSV(m.title),
                        escapeCSV(m.imdb),
                        escapeCSV(m.poster),
                        escapeCSV(m.userRating), // Értékelés mentése
                        escapeCSV(m.tags ? m.tags.join('|') : "") // ÚJ: Címkék mentése | elválasztóval
                    ].join(',');
                }).join('\n');

                const csvContent = header + rows;
                const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = 'film_katalogus.csv';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);

                showMessage('Katalógus sikeresen mentve (.csv)!', 'success');
            }

            /**
             * A "Betöltés" gomb eseménykezelője.
             */
            function triggerLoadFile() {
                loadInput.click();
            }

            /**
             * CSV sor felbontása.
             */
            function parseCSVLine(line) {
                const values = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    if (char === '"') {
                        if (inQuotes && line[i+1] === '"') {
                            current += '"';
                            i++;
                        } else {
                             inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        values.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                values.push(current);
                
                return values.map(v => {
                    let val = v.trim();
                    if (val.startsWith('"') && val.endsWith('"')) {
                        val = val.substring(1, val.length - 1);
                    }
                    return val.replace(/""/g, '"');
                });
            }

            /**
             * Fájl betöltésének eseménykezelője (értékeléssel).
             */
            function handleFileLoad(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const csvData = event.target.result;
                        const lines = csvData.split(/\r?\n/); 

                        if (lines.length < 2) {
                            showMessage('A CSV fájl üres vagy érvénytelen.');
                            return;
                        }

                        const headerLine = lines.shift().toLowerCase().replace("\uFEFF", "");
                        const headers = headerLine.split(',').map(h => h.trim());
                        
                        const idIndex = headers.indexOf('id');
                        const titleIndex = headers.indexOf('title');
                        const imdbIndex = headers.indexOf('imdb');
                        const posterIndex = headers.indexOf('poster');
                        const userRatingIndex = headers.indexOf('userrating'); // Új mező
                        const tagsIndex = headers.indexOf('tags'); // ÚJ

                        if (idIndex === -1 || titleIndex === -1 || imdbIndex === -1 || posterIndex === -1) {
                            showMessage('A CSV fejléc hiányos. Kötelező oszlopok: id, title, imdb, poster');
                            return;
                        }

                        const importedMovies = [];
                        for (const line of lines) {
                            if (line.trim() === '') continue; 

                            const values = parseCSVLine(line);

                            if (values.length >= 4) {
                                const movie = {
                                    id: values[idIndex],
                                    title: values[titleIndex],
                                    imdb: values[imdbIndex],
                                    poster: values[posterIndex],
                                    // Értékelés beolvasása, ha létezik, egyébként 0
                                    userRating: userRatingIndex > -1 ? (parseInt(values[userRatingIndex], 10) || 0) : 0,
                                    // ÚJ: Címkék beolvasása
                                    tags: tagsIndex > -1 && values[tagsIndex] ? values[tagsIndex].split('|').filter(t => t.length > 0) : []
                                };
                                if (movie.id && movie.title && movie.poster) {
                                    importedMovies.push(movie);
                                }
                            }
                        }
                        
                        // ÚJ: Globális címkelista frissítése az importált adatokból
                        const importedTags = new Set(allTags);
                        importedMovies.forEach(m => {
                            m.tags.forEach(t => importedTags.add(t));
                        });
                        allTags = Array.from(importedTags).sort();
                        updateAllTagsDatalist(); // Autokiegészítő frissítése

                        movies = importedMovies;
                        saveToLocalStorage(); // Mentjük az importált filmeket ÉS a frissített címkelistát
                        renderMovies();
                        searchBox.value = ''; // Kereső ürítése
                        showMessage(`Katalógus sikeresen betöltve! (${importedMovies.length} film importálva)`, 'success');
                        
                    } catch (error) {
                        showMessage('Hiba történt a CSV fájl beolvasása közben.');
                        console.error("CSV Parse Error:", error);
                    }
                };
                
                reader.onerror = () => showMessage('Hiba történt a fájl olvasása közben.');
                reader.readAsText(file, "UTF-8");
                e.target.value = null;
            }

            // === ESEMÉNYKEZELŐK RÁKÖTÉSE ===

            // Keresés az OMDB-n
            searchOmdbForm.addEventListener('submit', handleOMDBSearch);

            // Modál bezárása
            closeModalBtn.addEventListener('click', closeModal);
            searchModal.addEventListener('click', (e) => {
                // Bezárás, ha a háttérre kattint
                if (e.target === searchModal) {
                    closeModal();
                }
            });

            // Hozzáadás a modálból
            searchResultsGrid.addEventListener('click', handleAddFromSearch);
            
            // Keresés a *helyi* katalógusban
            searchBox.addEventListener('input', handleLocalSearch);

            // Törlés VAGY Értékelés a *saját* katalógusból (Event Delegation)
            catalogGrid.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.delete-btn');
                const ratingStar = e.target.closest('.rating-star');
                const removeTagBtn = e.target.closest('.remove-tag-btn'); // ÚJ

                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    deleteMovie(id);
                    return; // Megállunk, hogy ne triggerelje a csillagot
                }

                if (ratingStar) {
                    const id = ratingStar.parentElement.dataset.id;
                    const ratingValue = parseInt(ratingStar.dataset.value, 10);
                    handleRatingClick(id, ratingValue);
                    return; // ÚJ
                }

                // ÚJ: Címke eltávolítása
                if (removeTagBtn) {
                    const movieId = removeTagBtn.dataset.movieId;
                    const tagName = removeTagBtn.dataset.tagName;
                    handleRemoveTag(movieId, tagName);
                    return;
                }
            });

            // ÚJ: Címke hozzáadása (submit esemény a formon)
            catalogGrid.addEventListener('submit', (e) => {
                const addTagForm = e.target.closest('.add-tag-form');
                if (addTagForm) {
                    e.preventDefault(); // Alapértelmezett űrlapküldés megállítása
                    const movieId = addTagForm.dataset.id;
                    const input = addTagForm.querySelector('.tag-input');
                    const tagName = input.value.trim();
                    
                    if (tagName) {
                        handleAddTag(movieId, tagName);
                        input.value = ''; // Mező kiürítése
                    }
                }
            });

            // Mentés gomb
            saveBtn.addEventListener('click', saveCatalogToFile);

            // Betöltés gomb
            loadBtn.addEventListener('click', triggerLoadFile);

            // Fájl kiválasztása
            loadInput.addEventListener('change', handleFileLoad);

            // === INICIALIZÁLÁS ===
            loadFromLocalStorage();
            updateAllTagsDatalist(); // ÚJ: Autokiegészítő feltöltése indításkor
            renderMovies();
        });
    </script>

</body>
</html>




